# 파일 이름: .github/workflows/deploy.yml
# (최종 - DB 플래그 방식)

name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub 저장소의 코드를 가져옴
      - name: Checkout
        uses: actions/checkout@v4

      # 2. GCP 서비스 계정 키(JSON)를 사용해 로그인
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3. gcloud 명령어 사용 준비
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: 'gen-lang-client-0683011321' # 네 프로젝트 ID

      # 4. 이미지 빌드 및 푸시 (Dockerfile이 빌드 및 설치를 모두 처리)
      - name: Build and Push Docker image
        run: |-
          gcloud builds submit --tag us-central1-docker.pkg.dev/gen-lang-client-0683011321/my-spring-repo/gemini-discord-bot

      # 5. Cloud Run에 배포
      - name: Deploy to Cloud Run
        run: |-
          gcloud run deploy gemini-discord-bot \
            --image="us-central1-docker.pkg.dev/gen-lang-client-0683011321/my-spring-repo/gemini-discord-bot" \
            --project="gen-lang-client-0683011321" \
            --region="us-central1" \
            --cpu=1 \
            --memory=1Gi \
            --min-instances=1 \
            --no-cpu-throttling \
            --set-env-vars="COMMIT_SHA=${{ github.sha }},DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }},GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},MONGODB_URI=${{ secrets.MONGODB_URI }},FLOWISE_ENDPOINT=${{ secrets.FLOWISE_ENDPOINT }},FLOWISE_API_KEY=${{ secrets.FLOWISE_API_KEY }},DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }},DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }},EQK_AUTH_KEY=${{ secrets.EQK_AUTH_KEY }},GOOGLE_SEARCH_API=${{ secrets.GOOGLE_SEARCH_API }},GOOGLE_SEARCH_ENGINE_ID=${{ secrets.GOOGLE_SEARCH_ENGINE_ID }},DISCORD_LOG_CHANNEL_ID=${{ secrets.DISCORD_LOG_CHANNEL_ID }},JWT_SECRET=${{ secrets.JWT_SECRET }},MY_DISCORD_USER_ID=${{ secrets.MY_DISCORD_USER_ID }}" \
            --allow-unauthenticated