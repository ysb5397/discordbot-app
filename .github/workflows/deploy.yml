name: Deploy to Koyeb

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # GitHub Container Registryì— ì—…ë¡œë“œí•˜ê¸° ìœ„í•œ ê¶Œí•œ

    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. ì´ë¯¸ì§€ íƒœê·¸ ì†Œë¬¸ìë¡œ ë³€í™˜ (ìˆ˜ì •ë¨)
      - name: ğŸ”¤ Lowercase Repo Name
        run: |
          echo "IMAGE_ID=$(echo ghcr.io/${{ github.repository_owner }}/discordbot-app | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # 3. Buildx ì„¤ì • (ëª…ì‹œì  ë“œë¼ì´ë²„ ì„¤ì •)
      - name: ğŸ”¨ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          install: true

      # 4. GitHub Container Registry ë¡œê·¸ì¸
      - name: ğŸ”“ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: ğŸ“¦ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_ID }}:latest
          # ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ìºì‹œ ì„¤ì •
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 6. Koyeb CLI ì„¤ì¹˜
      - name: ğŸ”§ Install Koyeb CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sudo sh
          sudo mv /root/.koyeb/bin/koyeb /usr/local/bin/koyeb
          koyeb version

      # 7. Koyebìœ¼ë¡œ ë°°í¬ (ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ & COMMIT_SHA ê°±ì‹ )
      - name: ğŸš€ Deploy to Koyeb
        run: |
          koyeb service update defiant-tally/discordbot-app \
            --token ${{ secrets.KOYEB_API_TOKEN }} \
            --docker ${{ env.IMAGE_ID }}:latest \
            --env COMMIT_SHA=${{ github.sha }}