name: Deploy to Koyeb

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # GitHub Container Registryì— ì—…ë¡œë“œí•˜ê¸° ìœ„í•œ ê¶Œí•œ

    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. ì´ë¯¸ì§€ íƒœê·¸ ì†Œë¬¸ìë¡œ ë³€í™˜ (Docker íƒœê·¸ ì˜¤ë¥˜ ë°©ì§€)
      - name: ğŸ”¤ Lowercase Repo Name
        run: |
          echo "IMAGE_ID=ghcr.io/${{ github.repository_owner }}/discordbot-app" | tr '[:upper:]' '[:lower:]' >> $GITHUB_ENV

      # 3. GitHub Container Registry ë¡œê·¸ì¸
      - name: ğŸ”“ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. Buildx ì„¤ì • (ìºì‹œ ì‚¬ìš©ì„ ìœ„í•´ í•„ìˆ˜)
      - name: ğŸ”¨ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: ğŸ“¦ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_ID }}:latest
          # ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ìºì‹œ ì„¤ì •
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 6. Koyeb CLI ì„¤ì¹˜
      - name: ğŸ”§ Install Koyeb CLI
        run: |
          curl -L https://github.com/koyeb/koyeb-cli/releases/download/v4.2.0/koyeb-linux-amd64.tar.gz | tar -xz
          sudo mv koyeb /usr/local/bin/

      # 7. Koyebìœ¼ë¡œ ë°°í¬ (ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ & COMMIT_SHA ê°±ì‹ )
      - name: ğŸš€ Deploy to Koyeb
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          koyeb service update discordbot-app \
            --docker-image ${{ env.IMAGE_ID }}:latest \
            --env COMMIT_SHA=${{ github.sha }}
            --env DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }}
            --env GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            --env MONGODB_URI=${{ secrets.MONGODB_URI }}
            --env FLOWISE_ENDPOINT=${{ secrets.FLOWISE_ENDPOINT }}
            --env FLOWISE_API_KEY=${{ secrets.FLOWISE_API_KEY }}
            --env DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
            --env DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}
            --env EQK_AUTH_KEY=${{ secrets.EQK_AUTH_KEY }}
            --env GOOGLE_SEARCH_API=${{ secrets.GOOGLE_SEARCH_API }}
            --env GOOGLE_SEARCH_ENGINE_ID=${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
            --env DISCORD_LOG_CHANNEL_ID=${{ secrets.DISCORD_LOG_CHANNEL_ID }}
            --env JWT_SECRET=${{ secrets.JWT_SECRET }}
            --env MY_DISCORD_USER_ID=${{ secrets.MY_DISCORD_USER_ID }}
            --env URL_CHECK_API_KEY=${{ secrets.URL_CHECK_API_KEY }}